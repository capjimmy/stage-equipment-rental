[문서명] 미비사항 보완 답변서 v1 (운영정책 확정 + 결제/배송/계약 보완)
[작성 목적] 기존 설계 TXT에 대한 “미비된 부분/개선 제안” 검토 결과를 반영하고, 사용자가 추가로 확정한 운영정책(유예기간, 계좌이체 승인형 결제, 배송 정책, 계약/책임 조항)을 개발 명세로 제공한다.
[전제] 나머지 항목(User/Category/가격정책/인덱스/표준응답/HOLD 등)은 기존 추천안을 따르되, 아래 항목은 사용자 확정사항으로 우선 반영한다.

========================================================
1) 예약 충돌 검증 정책 확정 (유예기간/버퍼 필수)
========================================================
1-1. 확정 정책(사용자 결정)
- “반납일과 다음 대여 시작일은 같으면 안 된다.”
- 최소 1일의 유예기간(buffer_days=1)이 기본이며, 이는 모든 상품/자산에 기본 적용한다.
- 즉, 실제 대여기간이 end_date로 끝나면, 다음 대여의 start_date는 최소 end_date+1 이후여야 한다.

1-2. 시스템 처리 규칙(개발 명세)
- Rental(또는 예약 블로킹) 충돌 판단은 “실제 대여기간 + 버퍼기간”을 포함한 ‘블로킹 기간’ 기준으로 수행한다.
- 블로킹 기간:
  - blocked_start = start_date
  - blocked_end   = end_date + buffer_days (기본 buffer_days=1)
- 충돌 조건:
  - 같은 asset_id에 대해 두 블로킹 기간이 겹치면(Overlapping) 신규 예약/확정 불가
  - 예: A-001이 2025-03-10~2025-03-13 대여면, blocked_end=2025-03-14
        그러므로 2025-03-14 시작 예약은 불가, 2025-03-15부터 가능

1-3. 향후 확장 여지(옵션)
- 버퍼는 “상품/카테고리별”로 조정 가능하도록 확장 가능:
  - 예) 의상(세탁) 1~2일, 소품 1일, 장비 0~1일 등
- MVP에서는 전부 buffer_days=1로 통일(권장)

========================================================
2) 결제 시스템을 ‘일단 계좌이체 승인형’으로 운용 (수동 승인 2단계)
========================================================
2-1. 사용자 운영 로직(확정)
- 결제(PG) 구축은 2차로 미루고, 당장은 계좌이체 기반으로 진행한다.
- 로직 흐름:
  1) 고객이 예약 요청(신청) 생성
  2) 운영자가 “1차 승인”을 누르면 -> 해당 기간 일정이 임시로 막힘(Temporary Hold/Block)
     동시에 고객에게 계좌번호 안내(입금 요청)
  3) 고객이 입금
  4) 운영자가 “2차 승인(입금 확인)”을 누르면 -> 일정이 확정(Confirmed)
  5) 운영자가 “거절”을 누르면 -> 임시로 막힌 일정이 해제(Release)되어 다시 예약 가능 상태가 됨

2-2. 상태 머신 정의(필수)
- 주문/예약 상태를 명확히 분리해 운영 리스크를 줄인다.

[Order/Reservation Status] (권장 표준)
- REQUESTED        : 고객 예약 요청 생성(대기)
- HOLD_PENDINGPAY  : 운영자 1차 승인(입금대기) -> 일정 임시 차단(블로킹)
- CONFIRMED        : 입금 확인 후 2차 승인 -> 일정 확정
- REJECTED         : 운영자 거절 -> 블로킹 해제
- CANCELED         : 고객 취소(정책 범위 내)
- EXPIRED          : 입금 기한 초과로 자동 만료 -> 블로킹 해제(필수)

※ 주의: “HOLD_PENDINGPAY” 단계에서 ‘자산 배정/블로킹’이 실제로 걸려야 함.
        (더블부킹 방지의 핵심)

2-3. 필요한 신규 엔티티/필드 제안
A) Payment는 “PG 결제” 전제 대신 “입금 확인”을 다룰 수 있어야 한다.
- Payment(또는 BankTransfer)
  - payment_id
  - order_id (FK)
  - method = 'bank_transfer'
  - status = 'pending' | 'confirmed' | 'failed' | 'expired'
  - depositor_name (optional)
  - deposit_amount
  - deposit_deadline_at (입금기한)
  - confirmed_at
  - admin_confirmed_by (user_id)

B) Order에 추가(필수)
- payment_method ('bank_transfer' | 'pg' ... )
- payment_status (pending/confirmed/failed/expired)
- deposit_deadline_at (입금 기한)
- admin_approved_at_1 (1차 승인 시각)
- admin_approved_at_2 (2차 승인 시각)

2-4. “임시 일정 차단” 구현 방식(권장)
- 결제시 자동 HOLD 대신, 운영자 1차 승인 시점에 HOLD 생성.
- 구현 선택지:
  (1) Rental에 status='hold_pendingpay'로 레코드 생성(추천)
  (2) 별도 Block 테이블을 두고, Confirm 시 Rental로 전환
- MVP 권장: (1) Rental 테이블에 status를 세분화하여 hold/reserved/confirmed로 운용

2-5. 입금 기한/만료 정책(필수)
- 운영자 승인 후 무기한 홀드되면 재고 회전이 멈춘다.
- 기본 정책(권장):
  - 입금 기한: 24시간(또는 운영자 설정)
  - 기한 내 미입금: 자동 EXPIRED 처리 + 일정 해제
- 자동 처리:
  - 배치 작업(cron)으로 deposit_deadline_at 지난 HOLD_PENDINGPAY 주문/렌탈을 EXPIRED로 전환
  - 관련 rental/block를 해제
  - 고객에게 알림(선택)

2-6. 향후 PG 결제 전환 시 연결(확장 설계)
- 향후 볼륨이 커지면:
  - 고객 결제 성공(웹훅) 시점에 HOLD를 자동 생성/확정하는 기존 HOLD 정책으로 전환
- 현재 설계는 payment_method만 바꾸고, 상태 머신은 그대로 재사용 가능:
  - REQUESTED -> (PG 결제 진행) -> HOLD/CONFIRMED 자동화

========================================================
3) 배송 정책(운영자 배송) 확정 및 가격 전략 반영
========================================================
3-1. 사용자 운영 정책(확정)
- 당분간 배송은 플랫폼(운영자)이 직접 처리한다.
- 배송 방식:
  - 퀵(소량)
  - 택배(소량)
  - 묶음배송(중대량) : “대충 10만원” 고정가로 제공(업셀 유도 목적)

3-2. Order 엔티티에 추가(필수)
- delivery_method: 'quick' | 'parcel' | 'bundle'
- shipping_cost: number (원)
- shipping_address: string (또는 Address FK)
- return_address: string (또는 Address FK)
- delivery_notes: string (요청사항)
- pickup_datetime_window(optional): 배송 일정 협의용

3-3. 배송비 계산 정책(권장 명세)
- quick: 운영자 수동 견적 입력(거리/시간에 따라 변동)
- parcel: 운영자 수동 또는 규칙 기반(무게/박스 수) -> MVP는 수동 입력 권장
- bundle: 기본 100,000원 고정(사용자 확정)
  - 단, 향후 정책 변경 대비해 “배송정책 테이블”로 분리 가능

3-4. 운영 플로우(출고/반납 연동)
- CONFIRMED 이후에만 출고 준비 단계로 이동.
- 출고 상태(Fulfillment) 예시:
  - PREPARING -> DISPATCHED -> DELIVERED -> RETURN_REQUESTED -> RETURNED -> INSPECTED
- 반납(회수) 또한 배송 방식이 필요할 수 있음:
  - return_method: 'quick' | 'parcel' | 'bundle' (또는 order.delivery_method 재사용)

========================================================
4) 계약서/약관 필요: 파손/분실 + “뒷타임 영향 배상” 조항 포함
========================================================
4-1. 목적
- 렌탈은 물리적 리스크가 크며, 특히 “파손/분실로 인해 다음 예약(뒷타임)에 영향을 주는 경우” 손해가 커진다.
- 따라서 대여 계약/약관에 다음 내용을 최소 포함해야 한다:
  - 파손/분실/오염/연체 책임
  - 검수 기준 및 이슈 처리 절차
  - 다음 예약에 미치는 영향(기회손실/대체 비용) 배상 조항
  - 분쟁 해결 절차

4-2. 최소 계약(약관) 조항 초안(문구 템플릿)
※ 아래는 서비스 내 “대여 약관” 또는 별도 계약서에 포함할 핵심 조항의 문구 예시(법률 자문 전 단계 초안).

[조항 A: 반환 및 검수]
- 이용자는 대여 종료일(end_date)까지 대여 물품을 지정 방식(택배/퀵/직접)으로 반납해야 한다.
- 플랫폼은 반납 후 검수(세탁/점검 포함)를 진행하며, 검수 기간은 기본 1일 이상 소요될 수 있다(버퍼기간 정책과 연동).

[조항 B: 파손/분실/오염 책임]
- 이용자의 귀책으로 물품의 파손/분실/심각한 오염이 발생한 경우, 이용자는 수리비/복구비 또는 재구매 비용 상당액을 배상한다.
- 구체적 산정 방식(예: 경미/중대/전손)은 별도 정책표 또는 운영자 판단 기준에 따른다(MVP에서는 수동 산정 가능).

[조항 C: 연체(반납 지연)]
- 이용자가 반납기한을 초과하여 반납한 경우, 초과 일수에 대해 추가 요금이 부과될 수 있으며,
  해당 추가 요금은 기본 일 대여료 또는 별도 기준에 따라 산정한다.

[조항 D: 다음 예약(뒷타임) 영향 배상(핵심)]
- 이용자의 파손/분실/연체 등 귀책 사유로 인해 해당 물품 또는 동일 대체품의 다음 예약(뒷타임) 진행이 불가능해지는 경우,
  이용자는 다음 예약에 발생한 손해(대체물품 긴급 조달 비용, 배송/설치 추가비, 예약 취소에 따른 손해 등)를 배상할 책임이 있다.
- 손해 산정은 (1) 다음 예약의 대여료 상당액, (2) 대체 조달 및 긴급 운송 비용, (3) 기타 실비 증빙 가능한 비용을 기준으로 한다.
- 플랫폼은 손해 산정 내역을 이용자에게 통지하며, 이용자는 통지일로부터 일정 기간 내(예: 7일) 이의 제기할 수 있다.

[조항 E: 분쟁 처리]
- 파손/분실 여부 및 손해액에 관하여 다툼이 있을 경우, 플랫폼이 보유한 검수 기록(사진/영상/메모) 및 배송 기록을 우선 증거로 활용한다.
- 합의가 어려울 경우 민사상 절차에 따르며, 관할 법원/준거법은 플랫폼 사업장 소재지 기준으로 정할 수 있다(법률 자문 필요).

4-3. 시스템 구현(최소)
- RentalIssue(렌탈 이슈) 엔티티는 MVP에서도 “기록 + 추가청구(수동)”를 지원해야 한다.
- 이슈 발생 시:
  - 증빙 사진 업로드
  - 추가 청구액 입력
  - 상태: opened -> negotiating -> resolved -> billed/paid
- “뒷타임 영향”은 Issue.type 또는 Issue.subtype으로 표시:
  - type: damage/delay/loss
  - impact_next_booking: true/false
  - impact_notes, impact_cost

========================================================
5) 기존 미비사항 목록 중 ‘변경/유지’ 요약
========================================================
5-1. 유지(기존 추천안 그대로)
- User/Category 추가 및 RBAC
- 가격 계산 규칙(일수 inclusive) + 보증금 타입(고정/퍼센트) 도입
- 재고/Asset 배정(결제/확정 직전) 방식
- 알림(Notification) 최소 구현 권장
- 검색 성능 인덱스 전략 + 표준 API 응답 형식
- 관리자 운영 도구(핵심 기능 우선) 및 리포트 2차 확장

5-2. 변경(사용자 확정 반영)
- 반납일과 시작일 동일 불가 -> buffer_days=1 고정(MVP)
- 결제: PG 대신 계좌이체 승인형 프로세스(REQUESTED -> HOLD_PENDINGPAY -> CONFIRMED)
- 배송: 운영자 배송(퀵/택배/묶음배송), 묶음배송 10만원 고정(업셀 전략)
- 계약/약관: 파손/분실/연체 + 뒷타임 영향 배상 조항 포함(최소 문구 + 이슈 기록 시스템)

========================================================
6) 개발자(Claude) 작업 지시 요약 (바로 구현 포인트)
========================================================
- (필수) Rental 상태 머신에 “입금대기 홀드” 단계를 추가하고, 운영자 승인/거절에 따라 자산 블로킹 생성/해제 로직을 구현한다.
- (필수) 충돌 검증은 buffer_days=1 포함한 blocked_end 기준으로 수행한다.
- (필수) 입금기한 만료 배치 작업을 구현하여 HOLD_PENDINGPAY 상태가 무기한 점유되지 않도록 한다.
- (필수) 배송 방식 3종(quick/parcel/bundle) + bundle 100,000원 고정 정책을 Order에 반영한다.
- (필수) RentalIssue(파손/연체/분실/뒷타임영향) 최소 기록 및 추가청구액 저장 구조를 MVP에 포함한다.
- (필수) 약관/계약 문구(초안)를 서비스 내 체크박스 동의 또는 계약서 출력 형태로 제공할 수 있게 준비한다(법률 자문 전 단계 문구).

[끝]
